# 类调用关系图

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        Spring Boot Application                  │
├─────────────────────────────────────────────────────────────────┤
│  Application.java (主启动类)                                    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        配置层 (Config)                          │
├─────────────────────────────────────────────────────────────────┤
│  OllamaConfig.java          │  RedisClientConfig.java          │
│  ├─ ollamaApi()             │  ├─ redissonClient()             │
│  ├─ openAiApi()             │  └─ RedisClientConfigProperties  │
│  ├─ ollamaChatClient()      │                                  │
│  ├─ tokenTextSplitter()     │                                  │
│  ├─ vectorStore()           │                                  │
│  └─ pgVectorStore()         │                                  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                       接口层 (API)                              │
├─────────────────────────────────────────────────────────────────┤
│  IAiService.java            │  IRAGService.java                │
│  ├─ generate()              │  ├─ queryRagTagList()            │
│  ├─ generateStream()        │  ├─ uploadFile()                 │
│  └─ generateStreamRag()     │  └─ analyzeGitRepository()       │
│                             │                                  │
│  Response<T>.java           │                                  │
│  ├─ code                    │                                  │
│  ├─ info                    │                                  │
│  └─ data                    │                                  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      控制器层 (Controller)                      │
├─────────────────────────────────────────────────────────────────┤
│  OllamaController.java      │  OpenAiController.java           │
│  ├─ generate()              │  ├─ generate()                   │
│  ├─ generateStream()        │  ├─ generateStream()             │
│  └─ generateStreamRag()     │  └─ generateStreamRag()          │
│                             │                                  │
│  RAGController.java         │                                  │
│  ├─ queryRagTagList()       │                                  │
│  ├─ uploadFile()            │                                  │
│  └─ analyzeGitRepository()  │                                  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      外部服务层 (External Services)             │
├─────────────────────────────────────────────────────────────────┤
│  Ollama API                 │  OpenAI API                      │
│  ├─ Chat Client             │  ├─ Chat Client                  │
│  └─ Embedding Client        │  └─ Embedding Client             │
│                             │                                  │
│  PostgreSQL + pgvector      │  Redis + Redisson                │
│  ├─ Vector Store            │  ├─ Cache                        │
│  └─ Document Storage        │  └─ Tag Management               │
└─────────────────────────────────────────────────────────────────┘
```

## 详细类调用关系

### 1. 应用启动时的依赖注入关系

```
Application.java
    │
    ├─ @SpringBootApplication
    │   ├─ 自动扫描组件
    │   └─ 自动配置
    │
    ├─ OllamaConfig
    │   ├─ @Value("${spring.ai.ollama.base-url}")
    │   ├─ @Value("${spring.ai.openai.base-url}")
    │   ├─ @Value("${spring.ai.openai.api-key}")
    │   └─ @Value("${spring.ai.rag.embed}")
    │
    ├─ RedisClientConfig
    │   ├─ @EnableConfigurationProperties(RedisClientConfigProperties.class)
    │   └─ RedisClientConfigProperties
    │       ├─ @ConfigurationProperties(prefix = "redis.sdk.config")
    │       └─ 各种Redis配置属性
    │
    └─ 自动注入的Spring AI组件
        ├─ OllamaChatClient
        ├─ OpenAiChatClient
        ├─ TokenTextSplitter
        ├─ PgVectorStore
        └─ RedissonClient
```

### 2. 控制器依赖关系

```
OllamaController implements IAiService
    │
    ├─ @Resource OllamaChatClient chatClient
    ├─ @Resource PgVectorStore pgVectorStore
    │
    ├─ generate()
    │   └─ chatClient.call(Prompt)
    │
    ├─ generateStream()
    │   └─ chatClient.stream(Prompt)
    │
    └─ generateStreamRag()
        ├─ SearchRequest.query()
        ├─ pgVectorStore.similaritySearch()
        ├─ SystemPromptTemplate.createMessage()
        └─ chatClient.stream(Prompt)

OpenAiController implements IAiService
    │
    ├─ @Resource OpenAiChatClient chatClient
    ├─ @Resource PgVectorStore pgVectorStore
    │
    ├─ generate()
    │   └─ chatClient.call(Prompt)
    │
    ├─ generateStream()
    │   └─ chatClient.stream(Prompt)
    │
    └─ generateStreamRag()
        ├─ SearchRequest.query()
        ├─ pgVectorStore.similaritySearch()
        ├─ SystemPromptTemplate.createMessage()
        └─ chatClient.stream(Prompt)

RAGController implements IRAGService
    │
    ├─ @Resource OllamaChatClient ollamaChatClient
    ├─ @Resource TokenTextSplitter tokenTextSplitter
    ├─ @Resource SimpleVectorStore simpleVectorStore
    ├─ @Resource PgVectorStore pgVectorStore
    ├─ @Resource RedissonClient redissonClient
    │
    ├─ queryRagTagList()
    │   └─ redissonClient.getList("ragTag")
    │
    ├─ uploadFile()
    │   ├─ TikaDocumentReader.get()
    │   ├─ tokenTextSplitter.apply()
    │   ├─ pgVectorStore.accept()
    │   └─ redissonClient.getList("ragTag").add()
    │
    └─ analyzeGitRepository()
        ├─ Git.cloneRepository()
        ├─ Files.walkFileTree()
        ├─ TikaDocumentReader.get()
        ├─ tokenTextSplitter.apply()
        ├─ pgVectorStore.accept()
        └─ redissonClient.getList("ragTag").add()
```

### 3. 数据流调用关系

#### 文档上传流程
```
用户请求 → RAGController.uploadFile()
    │
    ├─ MultipartFile → TikaDocumentReader
    │   └─ Document[]
    │
    ├─ Document[] → TokenTextSplitter
    │   └─ Document[] (分割后)
    │
    ├─ Document[] → PgVectorStore.accept()
    │   ├─ EmbeddingClient.embed()
    │   └─ PostgreSQL存储
    │
    └─ ragTag → RedissonClient.getList("ragTag").add()
```

#### RAG问答流程
```
用户问题 → OllamaController.generateStreamRag()
    │
    ├─ SearchRequest.query(message)
    │   └─ withFilterExpression("knowledge == ragTag")
    │
    ├─ PgVectorStore.similaritySearch(request)
    │   ├─ EmbeddingClient.embed(message)
    │   ├─ 向量相似度计算
    │   └─ Document[] (相关文档)
    │
    ├─ Document[] → SystemPromptTemplate
    │   └─ Message (系统提示词)
    │
    ├─ [UserMessage, SystemMessage] → Prompt
    │
    └─ Prompt → OllamaChatClient.stream()
        └─ ChatResponse (流式回复)
```

### 4. 配置类依赖关系

```
OllamaConfig
    │
    ├─ @Value注入配置
    │   ├─ spring.ai.ollama.base-url
    │   ├─ spring.ai.openai.base-url
    │   ├─ spring.ai.openai.api-key
    │   └─ spring.ai.rag.embed
    │
    ├─ Bean: OllamaApi
    │   └─ new OllamaApi(baseUrl)
    │
    ├─ Bean: OpenAiApi
    │   └─ new OpenAiApi(baseUrl, apikey)
    │
    ├─ Bean: OllamaChatClient
    │   └─ new OllamaChatClient(ollamaApi)
    │
    ├─ Bean: TokenTextSplitter
    │   └─ new TokenTextSplitter()
    │
    ├─ Bean: SimpleVectorStore
    │   ├─ 条件: model == "nomic-embed-text"
    │   │   └─ OllamaEmbeddingClient
    │   └─ 条件: model != "nomic-embed-text"
    │       └─ OpenAiEmbeddingClient
    │
    └─ Bean: PgVectorStore
        ├─ 条件: model == "nomic-embed-text"
        │   └─ OllamaEmbeddingClient + JdbcTemplate
        └─ 条件: model != "nomic-embed-text"
            └─ OpenAiEmbeddingClient + JdbcTemplate

RedisClientConfig
    │
    ├─ @EnableConfigurationProperties(RedisClientConfigProperties.class)
    │
    ├─ Bean: RedissonClient
    │   ├─ Config.setCodec(JsonJacksonCodec.INSTANCE)
    │   ├─ Config.useSingleServer()
    │   │   ├─ setAddress(host:port)
    │   │   ├─ setConnectionPoolSize()
    │   │   ├─ setConnectionMinimumIdleSize()
    │   │   ├─ setIdleConnectionTimeout()
    │   │   ├─ setConnectTimeout()
    │   │   ├─ setRetryAttempts()
    │   │   ├─ setRetryInterval()
    │   │   ├─ setPingConnectionInterval()
    │   │   └─ setKeepAlive()
    │   └─ Redisson.create(config)
    │
    └─ RedisClientConfigProperties
        ├─ @ConfigurationProperties(prefix = "redis.sdk.config")
        ├─ host, port, password
        ├─ poolSize, minIdleSize
        ├─ idleTimeout, connectTimeout
        ├─ retryAttempts, retryInterval
        ├─ pingInterval, keepAlive
        └─ 默认值配置
```

### 5. 外部服务调用关系

```
Spring Boot应用
    │
    ├─ Ollama服务 (本地/远程)
    │   ├─ HTTP请求 → Ollama API
    │   ├─ 聊天模型调用
    │   └─ 嵌入模型调用
    │
    ├─ OpenAI服务 (远程)
    │   ├─ HTTP请求 → OpenAI API
    │   ├─ 聊天模型调用
    │   └─ 嵌入模型调用
    │
    ├─ PostgreSQL数据库
    │   ├─ JDBC连接
    │   ├─ 向量存储 (pgvector)
    │   └─ 文档元数据存储
    │
    └─ Redis缓存
        ├─ Redisson客户端
        ├─ 知识库标签缓存
        └─ 分布式锁支持
```

## 关键设计模式

1. **依赖注入模式**: 使用Spring的@Resource和@Autowired进行依赖注入
2. **配置模式**: 使用@ConfigurationProperties进行配置管理
3. **策略模式**: 支持多种AI模型和向量存储的灵活切换
4. **模板方法模式**: 统一的API响应格式
5. **工厂模式**: 根据配置创建不同的AI客户端

## 扩展点

1. **新的AI模型**: 实现IAiService接口
2. **新的向量存储**: 实现VectorStore接口
3. **新的文档解析器**: 实现DocumentReader接口
4. **新的文本分割器**: 实现TextSplitter接口
5. **新的缓存策略**: 实现Cache接口 